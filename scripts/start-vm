#!/bin/bash

# Exit on any error
set -e

VM_PATH="/var/lib/libvirt/images/ubuntu.qcow2"

# Check if VM image exists
if [ ! -f "$VM_PATH" ]; then
    echo "Error: VM image not found at $VM_PATH"
    exit 1
fi

# Get primary ethernet and wifi interface names
ETH_IF=$(ip -o link show | awk -F': ' '$2 ~ /^en|^eth/ {print $2}' | head -n1)
WIFI_IF=$(ip -o link show | awk -F': ' '$2 ~ /^wl/ {print $2}' | head -n1)

# Print detected network interfaces
if [ ! -z "$ETH_IF" ]; then
    echo "Found ethernet interface: $ETH_IF"
fi
if [ ! -z "$WIFI_IF" ]; then
    echo "Found wifi interface: $WIFI_IF" 
fi

if [ -z "$ETH_IF" ] && [ -z "$WIFI_IF" ]; then
    echo "Error: No ethernet or wifi interfaces found"
    exit 1
fi

# Create bridge for ethernet if available
if [ ! -z "$ETH_IF" ]; then
    sudo ip link add br0 type bridge
    sudo ip link set dev "$ETH_IF" master br0
    sudo ip link set br0 up
    sudo ip link set "$ETH_IF" up
fi

# For WiFi, we'll use QEMU's user networking (NAT) instead of bridging
if [ ! -z "$WIFI_IF" ]; then
    echo "Using NAT networking for WiFi interface"
fi

# Build network device parameters
NET_PARAMS=""
if [ ! -z "$ETH_IF" ]; then
    NET_PARAMS+="-netdev bridge,br=br0,id=net0 -device virtio-net-pci,netdev=net0 "
fi
if [ ! -z "$WIFI_IF" ]; then
    # Forward host port 2222 to guest port 22 (SSH)
    NET_PARAMS+="-netdev user,id=net1,hostfwd=tcp::2222-:22 -device virtio-net-pci,netdev=net1 "
fi

# Start QEMU with network bridges
exec qemu-system-x86_64 -enable-kvm -m 4096 -cpu host -smp 10 \
    -drive file="$VM_PATH",if=virtio \
    -monitor none \
    -serial mon:stdio \
    -parallel none \
    -display sdl,gl=on \
    -full-screen \
    -device virtio-vga,xres=1920,yres=1200 \
    -usb -device usb-tablet -device usb-kbd \
    $NET_PARAMS

# Cleanup bridges on script exit
cleanup() {
    if [ ! -z "$ETH_IF" ]; then
        sudo ip link set dev "$ETH_IF" nomaster
        sudo ip link delete br0 type bridge
    fi
    # Remove WiFi bridge cleanup since we're not using it anymore
}

trap cleanup EXIT
