#!/bin/bash

# Exit on any error
set -e

# Function to check if we're on a Debian-based system
is_debian() {
    [ -f /etc/debian_version ]
}

echo "Starting security hardening script..."

# Update and upgrade system
echo "Updating and upgrading system..."
sudo apt update
sudo apt upgrade -y

sudo apt install -y ssh

# Install and configure UFW
if is_debian; then
    echo "Installing and configuring UFW..."
    sudo apt install -y ufw
    sudo ufw allow 22/tcp
    sudo ufw default deny incoming
    sudo ufw --force enable
fi

# Install and configure auditd
echo "Installing and configuring auditd..."
sudo apt install -y auditd
sudo systemctl enable auditd
sudo systemctl start auditd

# Configure audit rules
sudo tee /etc/audit/rules.d/audit.rules << 'EOF'
-w /etc/passwd -p wa -k passwd_changes
-w /var/log/auth.log -p wa -k auth_logs
-w /etc/sudoers -p wa -k sudo_changes
EOF

sudo systemctl restart auditd

# Configure SSH security
echo "Configuring SSH security..."
sudo sed -i 's/^PermitRootLogin.*$/PermitRootLogin no/' /etc/ssh/sshd_config
sudo sed -i 's/^PasswordAuthentication.*$/PasswordAuthentication no/' /etc/ssh/sshd_config
sudo systemctl restart ssh

# Install and configure Suricata IDS
echo "Installing Suricata IDS..."
#sudo apt install -y suricata
#sudo systemctl enable suricata
#sudo systemctl start suricata

# Install and configure AIDE
echo "Installing and configuring AIDE..."
sudo apt install -y aide
sudo aideinit || true  # Initialize AIDE database, ignore if already initialized

# Install and configure AppArmor
echo "Installing and configuring AppArmor..."
sudo apt install -y apparmor
sudo systemctl enable apparmor
sudo systemctl start apparmor

# Configure AppArmor profiles (if Firefox profile exists)
if [ -f /etc/apparmor.d/usr.bin.firefox ]; then
    sudo aa-enforce /etc/apparmor.d/usr.bin.firefox || true
    sudo aa-enforce /etc/apparmor.d/usr.bin.chromium-browser || true
fi

echo "Security hardening completed!"
